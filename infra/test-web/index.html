<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Multi-House Port Controller</title>
    <style>
      * {
        margin: 0;
        padding: 0;
        box-sizing: border-box;
      }

      body {
        font-family: "Arial", sans-serif;
        background: skyblue;
        height: 100vh;
        display: flex;
        flex-direction: column;
        overflow: hidden;
      }

      /* HEADER */
      .header {
        text-align: center;
        color: white;
        height: 10vh;
        display: flex;
        flex-direction: column;
        justify-content: center;
      }

      h1 {
        font-size: 2.5em;
        text-shadow: 2px 2px 4px rgba(0, 0, 0, 0.3);
      }

      /* SHARED VIEW BASE */
      .street-view,
      .focused-view {
        position: relative;
        width: 100%;
        height: 70vh;
        overflow: hidden;
      }

      /* STREET LINE */
      .horizon {
        position: absolute;
        bottom: 0;
        left: 0;
        right: 0;
        height: 60px;
        background: repeating-linear-gradient(
          to bottom,
          #698b55 0,
          #698b55 70%,
          #9b9b9b 70%,
          #9b9b9b 100%
        );
      }

      /* STREET HOUSES */
      .street-house {
        position: absolute;
        bottom: 5%;
        transform: translateX(-50%);
        transition: all 0.3s ease;
        cursor: pointer;
      }

      .street-house img {
        height: 120px;
        transition: all 0.3s ease;
      }

      .house-name {
        position: absolute;
        bottom: -25px;
        left: 50%;
        transform: translateX(-50%);
        background: white;
        padding: 4px 12px;
        border-radius: 4px;
        font-size: 12px;
        font-weight: bold;
        white-space: nowrap;
        box-shadow: 0 2px 5px rgba(0, 0, 0, 0.2);
        opacity: 0;
        transition: opacity 0.3s;
      }

      .street-house:hover .house-name {
        opacity: 1;
      }

      /* FOCUSED VIEW */
      .focused-view {
        display: none;
      }

      .focused-view.active {
        display: block;
      }

      .back-btn {
        position: absolute;
        top: 20px;
        left: 20px;
        background: white;
        border: none;
        padding: 10px 20px;
        border-radius: 5px;
        cursor: pointer;
        font-size: 14px;
        font-weight: bold;
        z-index: 10;
        transition: all 0.3s;
        box-shadow: 0 2px 5px rgba(0, 0, 0, 0.2);
      }

      .back-btn:hover {
        transform: translateY(-2px);
        box-shadow: 0 4px 8px rgba(0, 0, 0, 0.3);
      }

      /* XP-style floating controls */
      #floatingControls {
        position: absolute;
        top: 20px;
        left: 160px;
        display: flex;
        flex-direction: column;
        gap: 8px;
        width: 220px;
        padding-bottom: 10px;
        background: #ece9d8;
        border: 2px solid #003399;
        border-radius: 3px;
        box-shadow: 4px 4px 10px rgba(0, 0, 0, 0.3);
        font-family: "Tahoma", sans-serif;
        z-index: 11;
      }

      /* Title bar like Windows XP */
      #floatingControlsHeader {
        background: linear-gradient(to bottom, #0a246a, #3a6ea5);
        color: white;
        font-weight: bold;
        padding: 6px 10px;
        cursor: move;
        border-bottom: 1px solid #003399;
        border-top-left-radius: 2px;
        border-top-right-radius: 2px;
        font-size: 21px;
        letter-spacing: 0.3px;
      }

      /* XP-style buttons inside the box */
      #floatingControls button {
        background: #f0f0f0;
        border: 1px solid #808080;
        border-radius: 2px;
        padding: 5px 8px;
        margin: 0 10px;
        font-size: 15px;
        cursor: pointer;
        transition: background 0.15s, box-shadow 0.15s;
        text-align: left;
      }

      #floatingControls button:hover {
        background: #e0e0e0;
        box-shadow: inset 1px 1px #fff, inset -1px -1px #808080;
      }

      .house-container {
        position: relative;
        width: 100%;
        height: 100%;
      }

      .house-svg {
        position: absolute;
        left: 50%;
        transform: translateX(-50%);
        height: 100%;
      }

      /* WINDOW BUTTONS */
      .window-btn {
        position: absolute;
        width: 60px;
        cursor: pointer;
        border: none;
        background: transparent;
        padding: 0;
      }

      .window-btn img {
        width: 100%;
        height: 100%;
        pointer-events: none;
      }

      .window-btn:hover {
        filter: drop-shadow(0 0 10px rgba(255, 255, 255, 0.8));
      }

      .window-label {
        position: absolute;
        bottom: -30px;
        left: 50%;
        transform: translateX(-50%);
        background: white;
        padding: 4px 8px;
        border-radius: 4px;
        font-size: 11px;
        font-weight: bold;
        white-space: nowrap;
        box-shadow: 0 2px 5px rgba(0, 0, 0, 0.2);
        pointer-events: none;
        color: #333;
      }

      /* STATUS SECTION — Windows XP Style */
      .status-container {
        background: rgb(67, 67, 67);
        height: 20vh;
        display: flex;
        align-items: center;
      }

      .status {
        display: none;
        width: 40vh;
        max-width: 800px;
        margin: 0 auto;
        text-align: center;
        padding: 20px;
        padding-bottom: 10px;
        background: #ece9d8;
        border: 2px solid #003399;
        border-radius: 3px;
        box-shadow: 4px 4px 10px rgba(0, 0, 0, 0.3);
        font-family: "Tahoma", sans-serif;
        z-index: 11;
      }

      .status h2 {
        color: #003366;
        font-family: "Tahoma", "Verdana", sans-serif;
        font-size: 1.5em;
        margin-bottom: 10px;
        text-shadow: 1px 1px 0 #ffffff;
      }
      .focused-view.active + .status-container {
        background: repeating-linear-gradient(
          to bottom,
          #698b55 0,
          #698b55 50%,
          #9b9b9b 50%,
          #9b9b9b 100%
        );
      }
      .focused-view.active + .status-container .status {
        display: block;
      }

      .port-list {
        display: flex;
        flex-wrap: wrap;
        gap: 10px;
        justify-content: center;
        min-height: 40px;
      }

      .port-badge {
        background: linear-gradient(to bottom, #a8c3ff 0%, #3a6de0 100%);
        color: #ffffff;
        padding: 5px 15px;
        border-radius: 20px;
        font-size: 14px;
        font-family: "Tahoma", sans-serif;
        border: 1px solid #2f4fa1;
        box-shadow: inset 0 1px 0 #d6e3ff, 0 1px 2px rgba(0, 0, 0, 0.3);
        text-shadow: 0 1px 0 rgba(0, 0, 0, 0.3);
        display: inline-block;
        transition: all 0.2s ease;
      }

      .controls {
        margin-top: 15px;
        display: flex;
        gap: 10px;
        justify-content: center;
        flex-wrap: wrap;
      }

      button {
        background: white;
        color: black;
        border: none;
        padding: 10px 20px;
        border-radius: 5px;
        cursor: pointer;
        font-size: 14px;
        transition: background 0.3s;
      }

      .error {
        color: #e74c3c;
        margin-top: 10px;
      }

      .success {
        color: #27ae60;
        margin-top: 10px;
      }
    </style>
  </head>
  <body>
    <div class="header">
      <h1 id="viewName">Vintage Street</h1>
    </div>

    <!-- Street View -->
    <div class="street-view" id="streetView">
      <div class="horizon"></div>
      <!-- Houses will be dynamically added here -->
    </div>

    <!-- Focused View -->
    <div class="focused-view" id="focusedView">
      <div id="floatingControls">
        <div id="floatingControlsHeader">Control Panel</div>
        <button onclick="backToStreet()">← Back to Street</button>
        <button onclick="openAllPorts()">Open All Windows</button>
        <button onclick="closeAllPorts()">Close All Windows</button>
        <button onclick="refreshStatus()">Refresh Status</button>
      </div>
      <div class="house-container" id="houseContainer">
        <img id="houseSvg" class="house-svg" src="" alt="House" />
      </div>
    </div>

    <div class="status-container">
      <div id="portStatus" class="status">
        <h2>Open Ports</h2>
        <div class="port-list" id="portList">
          <span style="color: #999">No ports open</span>
        </div>
        <div id="message"></div>
      </div>
    </div>

    <script>
      const API_BASE = "http://localhost:5050/api";

      // Configuration for each house - now maps to Docker services
      const houses = [
        {
          id: 1,
          name: "Grandma's House",
          service: "socat1",
          svg: "house1.svg",
          sml_svg: "house1_sml.svg",
          windows: [
            { port: 23, name: "Telnet", x: 41, y: 68, scale: 200 },
            { port: 25, name: "SMTP", x: 49, y: 68, scale: 200 },
          ],
        },
        {
          id: 2,
          name: "Ferris Bueller House",
          service: "socat2",
          svg: "house2.svg",
          sml_svg: "house2_sml.svg",
          windows: [
            { port: 27017, name: "MongoDB", x: 34, y: 66, scale: 230 },
            { port: 3306, name: "MySQL", x: 45, y: 66, scale: 230 },
          ],
        },
        {
          id: 3,
          name: "Munster Mansion",
          service: "socat3",
          svg: "house3.svg",
          sml_svg: "house3_sml.svg",
          windows: [
            { port: 3000, name: "Node.js", x: 39, y: 55, scale: 200 },
            { port: 8000, name: "Django", x: 57, y: 55, scale: 200 },
          ],
        },
        {
          id: 4,
          name: "Brady Bunch House",
          service: "socat4",
          svg: "house4.svg",
          sml_svg: "house4_sml.svg",
          windows: [
            { port: 143, name: "IMAP", x: 35, y: 70, scale: 150 },
            { port: 993, name: "IMAPS", x: 49, y: 70, scale: 150 },
            { port: 110, name: "POP3", x: 60, y: 40, scale: 150 },
            { port: 587, name: "SMTP TLS", x: 60, y: 70, scale: 150 },
          ],
        },
        {
          id: 5,
          name: "Hacker House",
          service: "socat5",
          svg: "house5_sml.svg",
          sml_svg: "house5_sml.svg",
          windows: [],
        },
      ];

      let currentHouseIndex = null;
      let windowStates = {}; // {service: {port: boolean}}

      function initStreetView() {
        const streetView = document.getElementById("streetView");
        const totalHouses = houses.length;

        houses.forEach((house, index) => {
          const houseDiv = document.createElement("div");
          houseDiv.className = "street-house";
          houseDiv.dataset.houseId = house.id;

          // Position houses evenly along the street
          const position = ((index + 1) / (totalHouses + 1)) * 100;
          houseDiv.style.left = `${position}%`;
          houseDiv.style.transform = "translateX(-50%)";

          const img = document.createElement("img");
          img.src = "assets/" + house.sml_svg;
          img.alt = house.name;

          const label = document.createElement("div");
          label.className = "house-name";
          label.textContent = house.name;

          houseDiv.appendChild(img);
          houseDiv.appendChild(label);
          houseDiv.onclick = () => focusOnHouse(index);

          streetView.appendChild(houseDiv);
        });
      }

      function focusOnHouse(index) {
        currentHouseIndex = index;
        const house = houses[index];

        // Hide street view, show focused view
        document.getElementById("streetView").style.display = "none";
        document.getElementById("focusedView").classList.add("active");

        // Update active state in street view
        document.querySelectorAll(".street-house").forEach((h, i) => {
          h.classList.toggle("active", i === index);
        });

        loadHouse(index);
        refreshStatus();
      }

      function backToStreet() {
        document.getElementById("streetView").style.display = "block";
        document.getElementById("focusedView").classList.remove("active");
        document.getElementById("viewName").textContent = "Vintage Street";

        currentHouseIndex = null;

        // Clear windows
        const container = document.getElementById("houseContainer");
        const existingWindows = container.querySelectorAll(".window-btn");
        existingWindows.forEach((w) => w.remove());
      }

      function loadHouse(index) {
        const house = houses[index];
        const container = document.getElementById("houseContainer");
        const houseSvg = document.getElementById("houseSvg");
        const viewName = document.getElementById("viewName");

        if (!house) return console.error("Invalid house index:", index);

        viewName.textContent = house.name;

        // Update house SVG
        houseSvg.src = "assets/" + house.svg;

        // Remove existing window buttons
        const existingWindows = container.querySelectorAll(".window-btn");
        existingWindows.forEach((w) => w.remove());

        // initialise window states for this service
        if (!windowStates[house.service]) {
          windowStates[house.service] = {};
        }

        // Create window buttons
        house.windows.forEach((window) => {
          const btn = document.createElement("button");
          btn.className = "window-btn";
          btn.dataset.port = window.port;
          btn.style.left = `${window.x}%`;
          btn.style.top = `${window.y}%`;
          btn.style.width = `${window.scale}px`;
          btn.style.height = `${window.scale}px`;
          btn.style.transform = "translate(-50%, -50%)";
          btn.onclick = () => togglePort(window.port);

          const img = document.createElement("img");
          img.src = windowStates[house.service][window.port]
            ? "assets/window-open.svg"
            : "assets/window-closed.svg";
          img.alt = `Window for port ${window.port}`;

          const label = document.createElement("div");
          label.className = "window-label";
          label.textContent = `${window.name} (${window.port})`;

          btn.appendChild(img);
          btn.appendChild(label);
          container.appendChild(btn);
        });
      }

      async function togglePort(port) {
        if (currentHouseIndex === null) return;

        const house = houses[currentHouseIndex];
        const service = house.service;
        const isOpen = windowStates[service]?.[port] || false;

        // Optimistically update UI immediately
        if (!windowStates[service]) windowStates[service] = {};
        windowStates[service][port] = !isOpen;
        updateWindowButton(port);

        try {
          const endpoint = isOpen ? "/ports/close" : "/ports/open";
          const response = await fetch(`${API_BASE}${endpoint}`, {
            method: "POST",
            headers: {
              "Content-Type": "application/json",
            },
            body: JSON.stringify({
              service: service,
              port: port,
            }),
          });

          const data = await response.json();

          if (response.ok) {
            showMessage(`Port ${port} ${isOpen ? "closed" : "opened"} on ${service}`, "success");
            await refreshStatus();
          } else {
            // Revert on error
            windowStates[service][port] = isOpen;
            updateWindowButton(port);
            showMessage(`Error: ${data.error}`, "error");
          }
        } catch (error) {
          // Revert on error
          windowStates[service][port] = isOpen;
          updateWindowButton(port);
          showMessage(`Failed to connect to API: ${error.message}`, "error");
        }
      }

      function updateWindowButton(port) {
        if (currentHouseIndex === null) return;

        const house = houses[currentHouseIndex];
        const service = house.service;
        const btn = document.querySelector(`.window-btn[data-port="${port}"]`);

        if (btn) {
          const img = btn.querySelector("img");
          const isOpen = windowStates[service]?.[port] || false;
          img.src = isOpen ? "assets/window-open.svg" : "assets/window-closed.svg";
        }
      }

      async function openAllPorts() {
        if (currentHouseIndex === null) {
          showMessage("Please select a house first", "error");
          return;
        }

        const house = houses[currentHouseIndex];
        const service = house.service;
        const ports = house.windows.map((w) => w.port);

        // Optimistically update UI immediately
        if (!windowStates[service]) windowStates[service] = {};
        ports.forEach((port) => {
          windowStates[service][port] = true;
          updateWindowButton(port);
        });

        try {
          const response = await fetch(`${API_BASE}/ports/open-multiple`, {
            method: "POST",
            headers: {
              "Content-Type": "application/json",
            },
            body: JSON.stringify({
              service: service,
              ports: ports,
            }),
          });

          const data = await response.json();

          if (response.ok) {
            showMessage("All windows opened!", "success");
            await refreshStatus();
          } else {
            // Revert on error
            ports.forEach((port) => {
              windowStates[service][port] = false;
              updateWindowButton(port);
            });
            showMessage(`Error: ${data.error}`, "error");
          }
        } catch (error) {
          // Revert on error
          ports.forEach((port) => {
            windowStates[service][port] = false;
            updateWindowButton(port);
          });
          showMessage(`Failed to connect to API: ${error.message}`, "error");
        }
      }

      async function closeAllPorts() {
        if (currentHouseIndex === null) {
          showMessage("Please select a house first", "error");
          return;
        }

        const house = houses[currentHouseIndex];
        const service = house.service;

        // Optimistically update UI immediately
        const previousStates = {};
        if (windowStates[service]) {
          Object.keys(windowStates[service]).forEach((port) => {
            previousStates[port] = windowStates[service][port];
            windowStates[service][port] = false;
            updateWindowButton(parseInt(port));
          });
        }

        try {
          const response = await fetch(`${API_BASE}/ports/close-all`, {
            method: "POST",
            headers: {
              "Content-Type": "application/json",
            },
            body: JSON.stringify({
              service: service,
            }),
          });

          const data = await response.json();

          if (response.ok) {
            showMessage("All windows closed!", "success");
            await refreshStatus();
          } else {
            // Revert on error
            Object.keys(previousStates).forEach((port) => {
              windowStates[service][port] = previousStates[port];
              updateWindowButton(parseInt(port));
            });
            showMessage(`Error: ${data.error}`, "error");
          }
        } catch (error) {
          // Revert on error
          Object.keys(previousStates).forEach((port) => {
            windowStates[service][port] = previousStates[port];
            updateWindowButton(parseInt(port));
          });
          showMessage(`Failed to connect to API: ${error.message}`, "error");
        }
      }

      async function refreshStatus() {
        try {
          const response = await fetch(`${API_BASE}/ports/status`);
          const data = await response.json();

          if (response.ok) {
            // Update window states from all services
            data.services.forEach((serviceStatus) => {
              const serviceName = serviceStatus.service;
              if (!windowStates[serviceName]) {
                windowStates[serviceName] = {};
              }

              // Reset all ports for this service to closed
              Object.keys(windowStates[serviceName]).forEach((port) => {
                windowStates[serviceName][port] = false;
              });

              // Set open ports to true
              serviceStatus.open_ports.forEach((port) => {
                windowStates[serviceName][port] = true;
              });
            });

            // Update UI if we're viewing a specific house
            if (currentHouseIndex !== null) {
              const house = houses[currentHouseIndex];
              const service = house.service;
              const portList = document.getElementById("portList");

              const servicePorts = windowStates[service] || {};
              const openPorts = Object.keys(servicePorts)
                .filter((port) => servicePorts[port])
                .map((port) => parseInt(port));

              if (openPorts.length === 0) {
                portList.innerHTML = '<span style="color: #999;">No ports open</span>';
              } else {
                portList.innerHTML = openPorts
                  .map((port) => `<span class="port-badge">Port ${port}</span>`)
                  .join("");
              }

              // Update window buttons
              house.windows.forEach((window) => {
                updateWindowButton(window.port);
              });
            }
          }
        } catch (error) {
          console.error("Failed to refresh status:", error);
        }
      }

      function showMessage(msg, type) {
        const messageEl = document.getElementById("message");
        messageEl.textContent = msg;
        messageEl.className = type;
        setTimeout(() => {
          messageEl.textContent = "";
          messageEl.className = "";
        }, 3000);
      }

      // Make floating controls draggable
      function dragElement(elmnt) {
        let pos1 = 0,
          pos2 = 0,
          pos3 = 0,
          pos4 = 0;
        const header = document.getElementById(elmnt.id + "Header") || elmnt;

        header.onmousedown = dragMouseDown;

        function dragMouseDown(e) {
          e.preventDefault();
          pos3 = e.clientX;
          pos4 = e.clientY;
          document.addEventListener("mouseup", closeDragElement);
          document.addEventListener("mousemove", elementDrag);
        }

        function elementDrag(e) {
          e.preventDefault();
          elmnt.style.top = elmnt.offsetTop - (pos4 - e.clientY) + "px";
          elmnt.style.left = elmnt.offsetLeft - (pos3 - e.clientX) + "px";
          pos3 = e.clientX;
          pos4 = e.clientY;
        }

        function closeDragElement() {
          document.removeEventListener("mouseup", closeDragElement);
          document.removeEventListener("mousemove", elementDrag);
        }
      }

      dragElement(document.getElementById("floatingControls"));

      // initialise
      initStreetView();
      refreshStatus();

      // Auto-refresh every 5 seconds
      setInterval(refreshStatus, 5000);
    </script>
  </body>
</html>
