{% extends "base.html" %} {% block title %}Scan History - {{ scan.target }}{% endblock %} {% block
extra_css %}
<style>
  .timeline {
    position: relative;
    padding: 2rem 0;
  }
  .timeline::before {
    content: "";
    position: absolute;
    left: 30px;
    top: 0;
    bottom: 0;
    width: 3px;
    background: linear-gradient(180deg, #007bff 0%, #e9ecef 100%);
  }
  .timeline-item {
    position: relative;
    padding-left: 80px;
    margin-bottom: 2rem;
  }
  .timeline-dot {
    position: absolute;
    left: 18px;
    top: 0;
    width: 25px;
    height: 25px;
    border-radius: 50%;
    border: 4px solid white;
    box-shadow: 0 2px 8px rgba(0, 0, 0, 0.2);
    z-index: 1;
  }
  .timeline-dot.has-changes {
    background: #ffc107;
  }
  .timeline-dot.no-changes {
    background: #28a745;
  }
  .timeline-dot.critical {
    background: #dc3545;
    animation: pulse 2s infinite;
  }
  @keyframes pulse {
    0%,
    100% {
      box-shadow: 0 2px 8px rgba(220, 53, 69, 0.4);
    }
    50% {
      box-shadow: 0 2px 20px rgba(220, 53, 69, 0.8);
    }
  }
  .timeline-card {
    border: 1px solid #dee2e6;
    border-radius: 0.5rem;
    transition: all 0.3s;
  }
  .timeline-card:hover {
    box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
    transform: translateX(10px);
  }
  .timeline-card-header {
    background: #f8f9fa;
    padding: 1rem 1.25rem;
    border-bottom: 1px solid #dee2e6;
    border-radius: 0.5rem 0.5rem 0 0;
  }
  .timeline-card-body {
    padding: 1.25rem;
  }
  .change-badge {
    display: inline-flex;
    align-items: center;
    gap: 0.5rem;
    padding: 0.5rem 1rem;
    border-radius: 2rem;
    font-size: 0.85rem;
    font-weight: 600;
    margin-right: 0.5rem;
    margin-bottom: 0.5rem;
  }
  .change-badge i {
    font-size: 0.9rem;
  }
  .stats-grid {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(120px, 1fr));
    gap: 1rem;
    margin-top: 1rem;
  }
  .stat-box {
    text-align: center;
    padding: 0.75rem;
    background: #f8f9fa;
    border-radius: 0.5rem;
    border: 1px solid #e9ecef;
  }
  .stat-value {
    display: block;
    font-size: 1.5rem;
    font-weight: 700;
    line-height: 1;
  }
  .stat-label {
    display: block;
    font-size: 0.75rem;
    color: #6c757d;
    margin-top: 0.25rem;
  }
  .trend-chart {
    margin-top: 2rem;
    padding: 1.5rem;
    background: white;
    border: 1px solid #dee2e6;
    border-radius: 0.5rem;
  }
  .summary-box {
    background: linear-gradient(135deg, #e3f2fd 0%, #bbdefb 100%);
    padding: 1.5rem;
    border-radius: 0.5rem;
    margin-bottom: 2rem;
  }
  .empty-timeline {
    text-align: center;
    padding: 4rem 2rem;
    background: #f8f9fa;
    border-radius: 0.5rem;
  }
  .filter-tabs {
    display: flex;
    gap: 0.5rem;
    margin-bottom: 2rem;
    flex-wrap: wrap;
  }
  .filter-tab {
    padding: 0.5rem 1rem;
    border: 2px solid #dee2e6;
    background: white;
    border-radius: 2rem;
    cursor: pointer;
    transition: all 0.3s;
    font-size: 0.9rem;
  }
  .filter-tab:hover {
    border-color: #007bff;
    background: #e7f1ff;
  }
  .filter-tab.active {
    background: #007bff;
    color: white;
    border-color: #007bff;
  }
  .comparison-info {
    font-size: 0.85rem;
    color: #6c757d;
    margin-top: 0.75rem;
    padding-top: 0.75rem;
    border-top: 1px solid #e9ecef;
  }
</style>
{% endblock %} {% block content %}
<div class="container-fluid py-4">
  <!-- Breadcrumb -->
  <nav aria-label="breadcrumb" class="mb-3">
    <ol class="breadcrumb">
      <li class="breadcrumb-item"><a href="{{ url_for('dashboard.index') }}">Dashboard</a></li>
      <li class="breadcrumb-item">
        <a href="{{ url_for('dashboard.reports') }}">Delta Reports</a>
      </li>
      <li class="breadcrumb-item active">Scan History</li>
    </ol>
  </nav>
  <!-- Header -->
  <div class="detail-header">
    <div class="row align-items-center">
      <div class="col-md-8">
        <h1 class="mb-2"><i class="fas fa-history me-2"></i>Scan History</h1>
        <p class="mb-2">
          <i class="fas fa-network-wired me-2"></i>
          <strong>{{ scan.name if scan.name else 'Target' }}:</strong> {{ scan.target }}
        </p>
        <p class="mb-0">
          <i class="fas fa-chart-line me-2"></i>
          <strong>Total Reports:</strong> <span id="total-reports">{{ reports|length }}</span>
        </p>
      </div>
    </div>
  </div>
  {% if reports|length > 0 %}
  <!-- Summary Cards -->
  <div class="row g-3 mb-4">
    <div class="col-md-3 col-6">
      <div class="card border-danger">
        <div class="card-body d-flex align-items-center">
          <div class="me-3 text-danger">
            <div class="h5 mb-0" id="total-new-ports">
              {{ reports|sum(attribute='new_ports_count') }}
            </div>
            <small class="text-muted">New Open Ports</small>
          </div>
        </div>
      </div>
    </div>
    <div class="col-md-3 col-6">
      <div class="card border-success">
        <div class="card-body d-flex align-items-center">
          <div class="me-3 text-success">
            <div class="h5 mb-0" id="total-closed-ports">
              {{ reports|sum(attribute='closed_ports_count') }}
            </div>
            <small class="text-muted">Closed Ports</small>
          </div>
        </div>
      </div>
    </div>
    <div class="col-md-3 col-6">
      <div class="card border-warning">
        <div class="card-body d-flex align-items-center">
          <div class="me-3 text-warning">
            <div class="h5 mb-0" id="total-service-changes">
              {{ reports|sum(attribute='changed_services_count') }}
            </div>
            <small class="text-muted">Service Changes</small>
          </div>
        </div>
      </div>
    </div>
    <div class="col-md-3 col-6">
      <div class="card border-info">
        <div class="card-body d-flex align-items-center">
          <div class="me-3 text-info">
            <div class="h5 mb-0" id="total-host-changes">
              {{ reports|sum(attribute='new_hosts_count') +
              reports|sum(attribute='removed_hosts_count') }}
            </div>
            <small class="text-muted">Host Changes</small>
          </div>
        </div>
      </div>
    </div>
  </div>
  <!-- Filter Controls -->
  <div class="d-flex flex-wrap gap-3 align-items-center mb-4">
    <!-- STATUS FILTER -->
    <div>
      <select id="status-filter" class="form-select form-select-sm">
        <option value="all" selected>All Statuses</option>
        <option value="critical">Critical Only</option>
        <option value="changes">Changes Only</option>
        <option value="stable">Stable Only</option>
      </select>
    </div>
    <!-- CHANGE TYPE FILTER -->
    <div>
      <select id="change-type-filter" class="form-select form-select-sm">
        <option value="all" selected>All Change Types</option>
        <option value="new_ports">New Ports Only</option>
        <option value="new_hosts">New Hosts Only</option>
        <option value="service_changes">Service Changes Only</option>
        <option value="closed_ports">Closed Ports Only</option>
      </select>
    </div>
    <!-- SORT DROPDOWN -->
    <div>
      <select id="sort-filter" class="form-select form-select-sm">
        <option value="recent" selected>Most Recent</option>
        <option value="oldest">Oldest</option>
        <option value="most_changes">Most Changes</option>
        <option value="least_changes">Least Changes</option>
      </select>
    </div>
    <!-- RESET FILTERS -->
    <div>
      <button id="reset-filters" class="btn btn-sm btn-outline-secondary">Reset Filters</button>
    </div>
  </div>

  <!-- Timeline -->
  <div class="timeline">
    {% for report in reports %} {% set has_changes = report.new_ports_count > 0 or
    report.closed_ports_count > 0 or report.changed_services_count > 0 or report.new_hosts_count > 0
    or report.removed_hosts_count > 0 %} {% set is_critical = report.new_ports_count > 0 %}
    <div
      class="timeline-item"
      data-has-changes="{{ 'true' if has_changes else 'false' }}"
      data-is-critical="{{ 'true' if is_critical else 'false' }}"
      data-new-ports="{{ report.new_ports_count }}"
      data-closed-ports="{{ report.closed_ports_count }}"
      data-changed-services="{{ report.changed_services_count }}"
      data-new-hosts="{{ report.new_hosts_count }}"
      data-removed-hosts="{{ report.removed_hosts_count }}"
      data-created-at="{{ report.created_at.strftime('%Y-%m-%dT%H:%M:%S') }}">
      <div
        class="timeline-dot {% if is_critical %}critical{% elif has_changes %}has-changes{% else %}no-changes{% endif %}"></div>
      <div class="card">
        <div class="card-header">
          <div class="d-flex justify-content-between align-items-center">
            <div>
              <h5 class="mb-1">
                <i class="fas fa-calendar-alt text-primary me-2"></i>
                <time class="utc-time" datetime="{{ report.created_at }}">
                  {{ report.created_at}}
                </time>
              </h5>
            </div>
            <h5>
              {% if is_critical %}
              <span class="badge bg-danger">
                <i class="fas fa-exclamation-circle me-1"></i>Critical
              </span>
              {% elif has_changes %}
              <span class="badge bg-warning text-body">
                <i class="fas fa-info-circle me-1"></i>Changes Detected
              </span>
              {% else %}
              <span class="badge bg-success"> <i class="fas fa-check-circle me-1"></i>Stable </span>
              {% endif %}
            </h5>
          </div>
        </div>
        <div class="timeline-card-body">
          {% if has_changes %}
          <!-- Change Badges -->
          <div class="mb-3">
            {% if report.new_hosts_count > 0 %}
            <span class="change-badge bg-info bg-opacity-10 text-info">
              <i class="fas fa-plus-circle"></i>
              {{ report.new_hosts_count }} new host(s)
            </span>
            {% endif %} {% if report.removed_hosts_count > 0 %}
            <span class="change-badge bg-secondary bg-opacity-10 text-secondary">
              <i class="fas fa-minus-circle"></i>
              {{ report.removed_hosts_count }} removed host(s)
            </span>
            {% endif %} {% if report.new_ports_count > 0 %}
            <span class="change-badge bg-danger bg-opacity-10 text-danger">
              <i class="fas fa-door-open"></i>
              {{ report.new_ports_count }} new port(s)
            </span>
            {% endif %} {% if report.closed_ports_count > 0 %}
            <span class="change-badge bg-success bg-opacity-10 text-success">
              <i class="fas fa-door-closed"></i>
              {{ report.closed_ports_count }} closed port(s)
            </span>
            {% endif %} {% if report.changed_services_count > 0 %}
            <span class="change-badge bg-warning bg-opacity-10 text-warning">
              <i class="fas fa-exchange-alt"></i>
              {{ report.changed_services_count }} service change(s)
            </span>
            {% endif %}
          </div>
          <!-- Stats Grid -->
          <div class="stats-grid">
            <div class="stat-box">
              <span class="stat-value text-danger">+{{ report.new_ports_count }}</span>
              <span class="stat-label">New Ports</span>
            </div>
            <div class="stat-box">
              <span class="stat-value text-success">-{{ report.closed_ports_count }}</span>
              <span class="stat-label">Closed</span>
            </div>
            <div class="stat-box">
              <span class="stat-value text-warning">{{ report.changed_services_count }}</span>
              <span class="stat-label">Changed</span>
            </div>
            <div class="stat-box">
              <span class="stat-value text-info">
                {{ report.new_hosts_count + report.removed_hosts_count }}
              </span>
              <span class="stat-label">Host Δ</span>
            </div>
          </div>
          {% else %}
          <div class="mb-0">
            <i class="fas fa-check-circle me-2"></i>
            <strong>No changes detected</strong> - Network remained stable
          </div>
          {% endif %}
          <!-- Comparison Info -->
          {% if report.delta_data and report.delta_data.baseline and report.delta_data.current %}
          <div class="comparison-info">
            <i class="fas fa-info-circle me-1"></i>
            Comparing Result #{{ report.delta_data.baseline.result_id }} {% if
            report.baseline_result and report.baseline_result.is_partial() %}
            <i class="fas fa-exclamation-triangle text-warning ms-1" title="Partial scan"></i>
            {% endif %}
            <i class="fas fa-arrow-right mx-1"></i>
            Result #{{ report.delta_data.current.result_id }} {% if report.current_result and
            report.current_result.is_partial() %}
            <i class="fas fa-exclamation-triangle text-warning ms-1" title="Partial scan"></i>
            {% endif %} {% if (report.baseline_result and report.baseline_result.is_partial()) or
            (report.current_result and report.current_result.is_partial()) %}
            <span class="text-warning ms-2">(Contains partial scan)</span>
            {% endif %}
          </div>
          {% endif %}
          <!-- Action Buttons -->
          <div class="d-flex gap-2 mt-3 pt-3 border-top">
            <a
              href="{{ url_for('dashboard.view_delta_report', report_id=report.id) }}"
              class="btn btn-sm btn-primary">
              <i class="fas fa-eye me-1"></i>View Details
            </a>
            <a
              href="{{ url_for('dashboard.export_delta_report', report_id=report.id) }}"
              class="btn btn-sm btn-outline-success">
              <i class="fas fa-download me-1"></i>Export CSV
            </a>
            <a
              href="{{ url_for('dashboard.export_delta_report_json', report_id=report.id) }}"
              class="btn btn-sm btn-outline-info">
              <i class="fas fa-file-code me-1"></i>JSON
            </a>
          </div>
        </div>
      </div>
    </div>
    {% endfor %}
  </div>
  {% else %}
  <!-- Empty State -->
  <div class="empty-timeline">
    <i class="fas fa-history fa-5x text-muted opacity-50 mb-4"></i>
    <h3 class="text-muted">No Reports Yet</h3>
    <p class="text-muted">
      This scan doesn't have any delta reports yet.<br />
      Delta reports are created after running multiple scans.
    </p>
    <a href="{{ url_for('dashboard.index') }}" class="btn btn-primary mt-3">
      <i class="fas fa-play me-2"></i>Run a Scan
    </a>
  </div>
  {% endif %}
</div>
{% endblock %} {% block extra_js %}
<script>
  document.addEventListener("DOMContentLoaded", () => {
    const timelineItems = Array.from(document.querySelectorAll(".timeline-item"));
    const statusFilter = document.getElementById("status-filter");
    const changeTypeFilter = document.getElementById("change-type-filter");
    const sortFilter = document.getElementById("sort-filter");
    const resetFilters = document.getElementById("reset-filters");
    const totalReportsEl = document.getElementById("total-reports");

    function applyFilters() {
      const statusValue = statusFilter.value;
      const changeTypeValue = changeTypeFilter.value;

      let visibleCount = 0;

      timelineItems.forEach((item) => {
        const isCritical = item.dataset.isCritical === "true";
        const hasChanges = item.dataset.hasChanges === "true";
        const newPorts = parseInt(item.dataset.newPorts);
        const closedPorts = parseInt(item.dataset.closedPorts);
        const changedServices = parseInt(item.dataset.changedServices);
        const newHosts = parseInt(item.dataset.newHosts);
        const removedHosts = parseInt(item.dataset.removedHosts);

        let visible = true;

        // Status filter
        if (statusValue === "critical" && !isCritical) visible = false;
        else if (statusValue === "changes" && (!hasChanges || isCritical)) visible = false;
        else if (statusValue === "stable" && (hasChanges || isCritical)) visible = false;

        // Change type filter
        if (changeTypeValue !== "all") {
          if (changeTypeValue === "new_ports" && newPorts === 0) visible = false;
          else if (changeTypeValue === "closed_ports" && closedPorts === 0) visible = false;
          else if (changeTypeValue === "service_changes" && changedServices === 0) visible = false;
          else if (changeTypeValue === "new_hosts" && newHosts === 0) visible = false;
        }

        item.style.display = visible ? "" : "none";
        if (visible) visibleCount++;
      });

      // Update summary total
      totalReportsEl.textContent = visibleCount;
    }

    function applySorting() {
      const sortValue = sortFilter.value;

      const sorted = [...timelineItems].sort((a, b) => {
        const dateA = new Date(a.dataset.createdAt).getTime();
        const dateB = new Date(b.dataset.createdAt).getTime();

        const totalChangesA =
          parseInt(a.dataset.newPorts) +
          parseInt(a.dataset.closedPorts) +
          parseInt(a.dataset.changedServices) +
          parseInt(a.dataset.newHosts) +
          parseInt(a.dataset.removedHosts);
        const totalChangesB =
          parseInt(b.dataset.newPorts) +
          parseInt(b.dataset.closedPorts) +
          parseInt(b.dataset.changedServices) +
          parseInt(b.dataset.newHosts) +
          parseInt(b.dataset.removedHosts);

        if (sortValue === "recent") return dateB - dateA;
        else if (sortValue === "oldest") return dateA - dateB;
        else if (sortValue === "most_changes") return totalChangesB - totalChangesA;
        else if (sortValue === "least_changes") return totalChangesA - totalChangesB;
        return 0;
      });

      const timelineContainer = document.querySelector(".timeline");
      sorted.forEach((item) => timelineContainer.appendChild(item));
    }

    function resetAllFilters() {
      statusFilter.value = "all";
      changeTypeFilter.value = "all";
      sortFilter.value = "recent";
      applySorting();
      applyFilters();
    }

    statusFilter.addEventListener("change", applyFilters);
    changeTypeFilter.addEventListener("change", applyFilters);
    sortFilter.addEventListener("change", () => {
      applySorting();
      applyFilters();
    });
    resetFilters.addEventListener("click", resetAllFilters);

    // Initialize
    applySorting();
    applyFilters();
  });
</script>
{% endblock %}
