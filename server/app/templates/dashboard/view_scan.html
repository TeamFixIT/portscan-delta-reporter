{% extends "base.html" %} {% block content %}
<div class="container mt-4">
  <nav aria-label="breadcrumb">
    <ol class="breadcrumb">
      <li class="breadcrumb-item"><a href="{{ url_for('dashboard.scans') }}">Scans</a></li>
      <li class="breadcrumb-item"><a>{{ scan.id }}</a></li>
      <li class="breadcrumb-item active" aria-current="page">View</li>
    </ol>
  </nav>

  <h2>Scan Details: {{ scan.name }}</h2>
  <p class="text-muted">Created on {{ scan.created_at.strftime('%Y-%m-%d %H:%M:%S') }}</p>

  <div class="card mb-4">
    <div class="card-body">
      <h5 class="card-title">Scan Information</h5>
      <table class="table table-sm table-borderless mb-0">
        <tr>
          <th>Name:</th>
          <td>{{ scan.name }}</td>
        </tr>
        <tr>
          <th>Description:</th>
          <td>{{ scan.description or 'None' }}</td>
        </tr>
        <tr>
          <th>Target:</th>
          <td>{{ scan.target }}</td>
        </tr>
        <tr>
          <th>Ports:</th>
          <td>{{ scan.ports }}</td>
        </tr>
        <tr>
          <th>Arguments:</th>
          <td>{{ scan.scan_arguments }}</td>
        </tr>
        <tr>
          <th>Interval:</th>
          <td>{{ scan.interval_minutes }} minutes</td>
        </tr>
        <tr>
          <th>Active:</th>
          <td>{{ 'Yes' if scan.is_active else 'No' }}</td>
        </tr>
        <tr>
          <th>Scheduled:</th>
          <td>{{ 'Yes' if scan.is_scheduled else 'No' }}</td>
        </tr>
        <tr>
          <th>Last Run:</th>
          <td>{{ scan.last_run or 'Never' }}</td>
        </tr>
        <tr>
          <th>Next Run:</th>
          <td>{{ scan.next_run or 'Not scheduled' }}</td>
        </tr>
        <tr>
          <th>Updated At:</th>
          <td>{{ scan.updated_at }}</td>
        </tr>
      </table>
    </div>
  </div>

  <div class="card mb-4">
    <div class="card-body">
      <h5 class="card-title">Associated Tasks</h5>
      {% if tasks_pagination.items %}
      <table class="table table-striped table-sm">
        <thead>
          <tr>
            <th>Task ID</th>
            <th>Client</th>
            <th>Status</th>
            <th>Priority</th>
            <th>Created</th>
            <th>Completed</th>
            <th>Group</th>
          </tr>
        </thead>
        <tbody>
          {% for task in tasks_pagination.items %}
          <tr>
            <td>{{ task.task_id }}</td>
            <td>{{ task.client_id }}</td>
            <td>
              <span
                class="badge {% if task.status == 'completed' %}bg-success {% elif task.status == 'failed' %}bg-danger {% elif task.status == 'assigned' %}bg-warning {% else %}bg-secondary{% endif %}">
                {{ task.status }}
              </span>
            </td>
            <td>{{ task.priority }}</td>
            <td>{{ task.created_at }}</td>
            <td>{{ task.completed_at or 'N/A' }}</td>
            <td>{{ task.task_group_id }}</td>
          </tr>
          {% endfor %}
        </tbody>
      </table>

      <!-- Pagination controls -->
      <nav>
        <ul class="pagination pagination-sm justify-content-end">
          {% if tasks_pagination.has_prev %}
          <li class="page-item">
            <a
              class="page-link"
              href="{{ url_for('dashboard.view_scan', scan_id=scan.id, task_page=tasks_pagination.prev_num) }}"
              >Previous</a
            >
          </li>
          {% endif %} {% if tasks_pagination.has_next %}
          <li class="page-item">
            <a
              class="page-link"
              href="{{ url_for('dashboard.view_scan', scan_id=scan.id, task_page=tasks_pagination.next_num) }}"
              >Next</a
            >
          </li>
          {% endif %}
        </ul>
      </nav>
      {% else %}
      <p class="text-muted mb-0">No tasks created for this scan yet.</p>
      {% endif %}
    </div>
  </div>

  <div class="card">
    <div class="card-body">
      <h5 class="card-title">Scan Results</h5>

      {% if results_pagination.items %} {% for result in results_pagination.items %} {% set
      result_index = loop.index %} {# store outer loop index manually #}

      <div class="mb-4 border rounded p-3 bg-light">
        <h6>
          <strong>Result ID:</strong> {{ result.result_id }}
          <span
            class="badge {% if result.status == 'completed' %}bg-success {% elif result.status == 'failed' %}bg-danger {% elif result.status == 'pending' %}bg-warning {% else %}bg-secondary{% endif %}">
            {{ result.status }}
          </span>
          <span
            class="badge {% if result.type == 'full' %}bg-success {% elif result.type == 'partial' %}bg-warning {% else %}bg-secondary{% endif %}">
            {{ result.type }}
          </span>
        </h6>

        {% if result.parsed_results %}
        <div class="table-responsive">
          <table class="table table-bordered table-sm align-middle">
            <thead class="table-light">
              <tr>
                <th>Target</th>
                <th>Hostname</th>
                <th>State</th>
                <th>Open Ports</th>
                <th>Details</th>
              </tr>
            </thead>
            <tbody>
              {% for target, data in result.parsed_results.items() %} {% set collapse_id =
              "details-" ~ result_index ~ "-" ~ loop.index %}
              <tr>
                <td><code>{{ target }}</code></td>
                <td>{{ data.hostname or 'N/A' }}</td>
                <td>
                  <span
                    class="badge {% if data.state == 'up' %}bg-success{% else %}bg-secondary{% endif %}">
                    {{ data.state }}
                  </span>
                </td>
                <td>
                  {% if data.open_ports %} {{ data.open_ports | join(', ') }} {% else %}
                  <span class="text-muted">None</span>
                  {% endif %}
                </td>
                <td>
                  {% if data.port_details %}
                  <button
                    class="btn btn-sm btn-outline-primary"
                    type="button"
                    data-bs-toggle="collapse"
                    data-bs-target="#{{ collapse_id }}"
                    aria-expanded="false"
                    aria-controls="{{ collapse_id }}">
                    View Details
                  </button>
                  <div class="collapse mt-2" id="{{ collapse_id }}">
                    <table class="table table-sm mb-0">
                      <thead>
                        <tr>
                          <th>Port</th>
                          <th>Protocol</th>
                          <th>Service</th>
                          <th>Product</th>
                          <th>Version</th>
                          <th>Extra Info</th>
                        </tr>
                      </thead>
                      <tbody>
                        {% for port, p in data.port_details.items() %}
                        <tr>
                          <td>{{ port }}</td>
                          <td>{{ p.protocol }}</td>
                          <td>{{ p.name or 'N/A' }}</td>
                          <td>{{ p.product or 'N/A' }}</td>
                          <td>{{ p.version or 'N/A' }}</td>
                          <td>{{ p.extrainfo or 'N/A' }}</td>
                        </tr>
                        {% endfor %}
                      </tbody>
                    </table>
                  </div>
                  {% else %}
                  <span class="text-muted">No details</span>
                  {% endif %}
                </td>
              </tr>
              {% endfor %}
            </tbody>
          </table>
        </div>
        {% endif %}
      </div>
      {% endfor %}

      <!-- Pagination controls -->
      <nav>
        <ul class="pagination pagination-sm justify-content-end">
          {% if results_pagination.has_prev %}
          <li class="page-item">
            <a
              class="page-link"
              href="{{ url_for('dashboard.view_scan', scan_id=scan.id, result_page=results_pagination.prev_num) }}">
              Previous
            </a>
          </li>
          {% endif %} {% if results_pagination.has_next %}
          <li class="page-item">
            <a
              class="page-link"
              href="{{ url_for('dashboard.view_scan', scan_id=scan.id, result_page=results_pagination.next_num) }}">
              Next
            </a>
          </li>
          {% endif %}
        </ul>
      </nav>
      {% else %}
      <p class="text-muted mb-0">No results available.</p>
      {% endif %}
    </div>
  </div>
</div>
{% endblock %}
