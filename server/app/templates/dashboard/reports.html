{% extends "base.html" %} {% block title %}Network Security Overview{% endblock %} {% block
extra_css %}
<style>
  /* General Layout */
  .summary-card {
    transition: all 0.2s ease-in-out;
    border: 1px solid var(--bs-border-color);
  }
  .summary-card:hover {
    transform: translateY(-3px);
    box-shadow: 0 0.75rem 1.25rem rgba(0, 0, 0, 0.08);
  }

  /* Score Circle */
  .security-score-circle {
    width: 110px;
    height: 110px;
    border-radius: 50%;
    border: 5px solid;
    display: flex;
    flex-direction: column;
    align-items: center;
    justify-content: center;
    margin: 0 auto 1rem;
    font-weight: 600;
  }
  .score-excellent {
    border-color: #198754;
    background-color: rgba(25, 135, 84, 0.05);
    color: #198754;
  }
  .score-good {
    border-color: #0dcaf0;
    background-color: rgba(13, 202, 240, 0.05);
    color: #0dcaf0;
  }
  .score-warning {
    border-color: #ffc107;
    background-color: rgba(255, 193, 7, 0.05);
    color: #856404;
  }
  .score-critical {
    border-color: #dc3545;
    background-color: rgba(220, 53, 69, 0.05);
    color: #dc3545;
  }

  /* Card Styling */
  .scan-card {
    border-radius: 0.75rem;
    overflow: hidden;
    transition: 0.25s ease;
    background: var(--bs-card-bg);
    border: 1px solid var(--bs-border-color);
  }
  .scan-card:hover {
    transform: translateY(-3px);
    box-shadow: 0 0.75rem 1.25rem rgba(0, 0, 0, 0.08);
  }
  .scan-card-header {
    background: var(--bs-gray-100);
    padding: 1rem 1.25rem;
    border-bottom: 1px solid var(--bs-border-color);
  }

  .status-badge {
    font-size: 0.8rem;
    padding: 0.35rem 0.8rem;
    border-radius: 2rem;
    font-weight: 600;
  }
  .status-stable {
    background: #d1e7dd;
    color: #0f5132;
  }
  .status-changes {
    background: #fff3cd;
    color: #664d03;
  }
  .status-critical {
    background: #f8d7da;
    color: #842029;
  }

  /* Metrics */
  .metric-grid {
    display: grid;
    grid-template-columns: repeat(2, 1fr);
    gap: 0.75rem;
  }
  .metric-item {
    text-align: center;
    background: var(--bs-light);
    padding: 0.75rem;
    border-radius: 0.5rem;
  }
  .metric-value {
    font-size: 1.25rem;
    font-weight: 600;
  }

  /* Alert Banner */
  .alert-banner {
    background: linear-gradient(135deg, #fff3cd, #ffe69c);
    border-left: 5px solid #ffc107;
    padding: 1rem 1.25rem;
    border-radius: 0.5rem;
  }

  /* Empty State */
  .empty-state {
    padding: 5rem 2rem;
    color: var(--bs-secondary);
  }
</style>
{% endblock %} {% block content %}
<div class="container-fluid py-4">
  <!-- Breadcrumb -->
  <nav aria-label="breadcrumb" class="mb-3">
    <ol class="breadcrumb">
      <li class="breadcrumb-item"><a href="{{ url_for('dashboard.index') }}">Dashboard</a></li>
      <li class="breadcrumb-item active" aria-current="page">Delta Reports</li>
    </ol>
  </nav>

  <!-- Header -->
  <div class="d-flex justify-content-between align-items-center mb-3">
    <h2 class="mb-0">
      <i class="fas fa-shield-alt me-2 text-primary"></i>Network Security Overview
    </h2>
    <button class="btn btn-outline-primary" onclick="location.reload()">
      <i class="fas fa-sync-alt me-1"></i> Refresh
    </button>
  </div>

  <p class="text-muted mb-4">Current security posture across all monitored networks.</p>

  {% set scans_with_alerts = reports|selectattr('new_ports_count', 'gt',
  0)|map(attribute='scan_id')|unique|list|length %} {% if scans_with_alerts > 0 %}
  <div class="alert-banner mb-4">
    <div class="d-flex align-items-center">
      <i class="fas fa-exclamation-triangle fa-lg text-warning me-2"></i>
      <div>
        <strong>Security Alert:</strong> {{ scans_with_alerts }} network(s) have new open ports
        detected.
        <a href="#" class="fw-semibold text-decoration-none ms-1">Review changes →</a>
      </div>
    </div>
  </div>
  {% endif %}

  <!-- Summary Cards -->
  <div class="row g-3 mb-4">
    <div class="col-md-3 col-6">
      <div class="card summary-card">
        <div class="card-body d-flex align-items-center">
          <div class="me-3 text-primary"><i class="fas fa-network-wired fa-2x"></i></div>
          <div>
            <div class="h5 mb-0">{{ reports|map(attribute='scan_id')|unique|list|length }}</div>
            <small class="text-muted">Monitored Networks</small>
          </div>
        </div>
      </div>
    </div>
    <div class="col-md-3 col-6">
      <div class="card summary-card border-danger">
        <div class="card-body d-flex align-items-center">
          <div class="me-3 text-danger"><i class="fas fa-door-open fa-2x"></i></div>
          <div>
            <div class="h5 mb-0">{{ reports|sum(attribute='new_ports_count') }}</div>
            <small class="text-muted">New Open Ports</small>
          </div>
        </div>
      </div>
    </div>
    <div class="col-md-3 col-6">
      <div class="card summary-card border-success">
        <div class="card-body d-flex align-items-center">
          <div class="me-3 text-success"><i class="fas fa-door-closed fa-2x"></i></div>
          <div>
            <div class="h5 mb-0">{{ reports|sum(attribute='closed_ports_count') }}</div>
            <small class="text-muted">Closed Ports</small>
          </div>
        </div>
      </div>
    </div>
    <div class="col-md-3 col-6">
      <div class="card summary-card border-warning">
        <div class="card-body d-flex align-items-center">
          <div class="me-3 text-warning"><i class="fas fa-exchange-alt fa-2x"></i></div>
          <div>
            <div class="h5 mb-0">{{ reports|sum(attribute='changed_services_count') }}</div>
            <small class="text-muted">Service Changes</small>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- Scan Cards -->
  {% if reports|length > 0 %} {% set reports_by_scan = {} %} {% for report in reports %} {% if
  report.scan_id not in reports_by_scan %} {% set _ = reports_by_scan.update({report.scan_id: []})
  %} {% endif %} {% set _ = reports_by_scan[report.scan_id].append(report) %} {% endfor %}

  <div class="row g-4">
    {% for scan_id, scan_reports in reports_by_scan.items() %} {% set scan = scan_reports[0].scan %}
    {% set latest_report = scan_reports|sort(attribute='created_at', reverse=true)|first %} {% set
    new_ports_penalty = latest_report.new_ports_count * 10 %} {% set changed_services_penalty =
    latest_report.changed_services_count * 5 %} {% set new_hosts_penalty =
    latest_report.new_hosts_count * 3 %} {% set security_score = [0, 100 - new_ports_penalty -
    changed_services_penalty - new_hosts_penalty]|max %} {% set has_critical =
    latest_report.new_ports_count > 0 %} {% set has_changes = latest_report.new_ports_count > 0 or
    latest_report.closed_ports_count > 0 or latest_report.changed_services_count > 0 or
    latest_report.new_hosts_count > 0 or latest_report.removed_hosts_count > 0 %}

    <div class="col-lg-4 col-md-6">
      <div class="scan-card">
        <div class="scan-card-header d-flex justify-content-between">
          <div>
            <h5 class="mb-1">
              {{ scan.name if scan and scan.name else scan.target or 'Network #' ~ scan_id }}
            </h5>
            <small class="text-muted">{{ scan.target if scan else 'N/A' }}</small>
          </div>
          {% if has_critical %}
          <span class="status-badge status-critical"
            ><i class="fas fa-exclamation-circle me-1"></i> Alert</span
          >
          {% elif has_changes %}
          <span class="status-badge status-changes"
            ><i class="fas fa-info-circle me-1"></i> Changes</span
          >
          {% else %}
          <span class="status-badge status-stable"
            ><i class="fas fa-check-circle me-1"></i> Stable</span
          >
          {% endif %}
        </div>

        <div class="card-body">
          <div
            class="security-score-circle {% if security_score >= 90 %}score-excellent {% elif security_score >= 70 %}score-good {% elif security_score >= 50 %}score-warning {% else %}score-critical{% endif %}">
            <div class="fs-3">{{ security_score }}</div>
            <small
              >{% if security_score >= 90 %}Excellent{% elif security_score >= 70 %}Good{% elif
              security_score >= 50 %}Monitor{% else %}Critical{% endif %}</small
            >
          </div>

          <div class="metric-grid mb-3">
            <div class="metric-item">
              <span
                class="metric-value {% if latest_report.new_ports_count > 0 %}text-danger{% else %}text-success{% endif %}">
                {% if latest_report.new_ports_count > 0 %}+{% endif %}{{
                latest_report.new_ports_count }}
              </span>
              <small>New Ports</small>
            </div>
            <div class="metric-item">
              <span
                class="metric-value {% if latest_report.closed_ports_count > 0 %}text-success{% else %}text-muted{% endif %}">
                -{{ latest_report.closed_ports_count }}
              </span>
              <small>Closed Ports</small>
            </div>
            <div class="metric-item">
              <span
                class="metric-value {% if latest_report.new_hosts_count > 0 %}text-info{% else %}text-muted{% endif %}">
                +{{ latest_report.new_hosts_count }}
              </span>
              <small>New Hosts</small>
            </div>
            <div class="metric-item">
              <span
                class="metric-value {% if latest_report.changed_services_count > 0 %}text-warning{% else %}text-muted{% endif %}">
                {{ latest_report.changed_services_count }}
              </span>
              <small>Changed Services</small>
            </div>
          </div>

          <div class="text-muted small mb-3">
            <i class="fas fa-clock me-1"></i>{{ latest_report.created_at.strftime('%Y-%m-%d %H:%M')
            }} • <i class="fas fa-file-alt ms-2 me-1"></i>{{ scan_reports|length }} report(s)
          </div>

          <div class="d-grid gap-2">
            <a
              href="{{ url_for('dashboard.view_delta_report', report_id=latest_report.id) }}"
              class="btn btn-primary">
              <i class="fas fa-eye me-2"></i>View Latest Report
            </a>
            <div class="btn-group">
              <a
                href="{{ url_for('dashboard.scan_history', scan_id=scan_id) }}"
                class="btn btn-sm btn-outline-secondary">
                <i class="fas fa-history me-1"></i>History
              </a>
              <a
                href="{{ url_for('dashboard.export_delta_report', report_id=latest_report.id) }}"
                class="btn btn-sm btn-outline-success">
                <i class="fas fa-download me-1"></i>Export
              </a>
            </div>
          </div>
        </div>
      </div>
    </div>
    {% endfor %}
  </div>
  {% else %}
  <div class="empty-state text-center">
    <i class="fas fa-shield-alt fa-5x opacity-25 mb-3"></i>
    <h4>No Delta Reports Available</h4>
    <p>Run at least two scans of the same target to generate a comparison report.</p>
  </div>
  {% endif %}
</div>
{% endblock %}
