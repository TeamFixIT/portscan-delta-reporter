{% extends "base.html" %} {% block content %}
<div class="container mt-4">
  <h2>Connected Clients</h2>
  <table class="table table-striped">
    <thead>
      <tr>
        <th>MAC Address</th>
        <th>Hostname</th>
        <th>IP Address</th>
        <th>Scan Range</th>
        <th>Status</th>
        <th>Last Seen</th>
        <th>Created At</th>
      </tr>
    </thead>
    <tbody>
      {% for client in clients %}
      <tr>
        <td>{{ client.client_id }}</td>
        <td>{{ client.hostname }}</td>
        <td>{{ client.ip_address }}</td>
        <td>{{ client.scan_range }}</td>
        <td>
          <span
            class="badge {% if client.status == 'online' %}bg-success {% elif client.status == 'scanning' %}bg-warning {% else %}bg-secondary{% endif %}">
            {{ client.status }}
          </span>
        </td>
        <td>{{ client.last_seen }}</td>
        <td>{{ client.created_at }}</td>
        <td>
          <div class="btn-group btn-group-sm" role="group">
            <button
              class="btn btn-primary approve-client-btn"
              data-client-id="{{ client.client_id }}"
              title="Approve">
              <i class="bi bi-play-fill"></i>
            </button>
            <button
              class="btn btn-outline-info revoke-client-btn"
              data-client-id="{{ client.client_id }}"
              title="Revoke">
              <i class="bi bi-power"></i>
            </button>
            <button
              class="btn btn-outline-danger delete-client-btn"
              data-client-id="{{ client.client_id }}"
              title="Delete Client">
              <i class="bi bi-trash"></i>
            </button>
          </div>
        </td>
      </tr>
      {% else %}
      <tr>
        <td colspan="6" class="text-center">No clients found.</td>
      </tr>
      {% endfor %}
    </tbody>
  </table>
</div>
<script>
  // DELETE
  document.querySelectorAll(".delete-client-btn").forEach((btn) => {
    btn.addEventListener("click", function () {
      if (!confirm("Are you sure you want to delete this client?")) return;
      const clientId = this.dataset.clientId;
      fetch(`/api/clients/${clientId}`, { method: "DELETE" })
        .then((resp) => resp.json())
        .then((data) => {
          if (data.status === "success") {
            document.getElementById(`client-row-${clientId}`).remove();
          } else alert(data.message || "Failed to delete client.");
        })
        .catch((err) => alert("Error: " + err));
    });
  });

  // REVOKE
  document.querySelectorAll(".revoke-client-btn").forEach((btn) => {
    btn.addEventListener("click", function () {
      const clientId = this.dataset.clientId;
      btn.disabled = true;
      fetch(`/api/clients/${clientId}/revoke`, { method: "POST" })
        .then((resp) => resp.json())
        .then((data) => {
          alert(data.message || "Client revoked.");
        })
        .catch((err) => alert("Error: " + err))
        .finally(() => (btn.disabled = false));
    });
  });

  // APPROVE
  document.querySelectorAll(".approve-client-btn").forEach((btn) => {
    btn.addEventListener("click", function () {
      const clientId = this.dataset.clientId;
      fetch(`/api/clients/${clientId}/approve`, { method: "POST" })
        .then((resp) => resp.json())
        .then((data) => {
          if (data.status === "success") {
            location.reload();
          } else {
            alert(data.message || "Failed to approve client.");
          }
        })
        .catch((err) => alert("Error: " + err));
    });
  });
</script>
{% endblock %}
