{% extends "base.html" %} {% block extra_css %}

{% endblock %}{% block title %}Login - Port Detector{% endblock %} {% block content %}

<!-- full-screen gradient background -->
<div class="login-gradient-bg min-vh-100 d-flex align-items-center justify-content-center" 
     style="background: linear-gradient(135deg, var(--primary) 0%, var(--primary-dark) 100%);">

  <!-- container -->  
    <div class="container pt-lg-2">
    <div class="row justify-content-center">
      <div class="col-md-4 col-lg-5">

    <!-- Login Card -->
        <div class="card shadow-lg rounded-3">

      <!-- Card Header -->
          <div class="card-header text-center py-4 border-bottom"
              style="background-color: var(--bs-body-bg)">
              <h2 class="mb-2">
                <i class="bi bi-shield-check" style="color: var(--primary);"></i>
                Port Scanner
              </h2>
              <p class="text-muted mb-0">Sign in to your account</p>
            </div>

          <!-- Card Body -->
          <div class="card-body p-4">

            <!-- Microsoft SSO Button -->
            <div class="mb-4">
              <a href="{{ url_for('auth.entra_login') }}" 
                 class="btn btn-light btn-lg w-100 border shadow-sm">
                <svg xmlns="http://www.w3.org/2000/svg" 
                     width="20" height="20" viewBox="0 0 21 21" class="me-2">
                  <rect x="1" y="1" width="9" height="9" fill="#f25022" />
                  <rect x="11" y="1" width="9" height="9" fill="#7fba00" />
                  <rect x="1" y="11" width="9" height="9" fill="#00a4ef" />
                  <rect x="11" y="11" width="9" height="9" fill="#ffb900" />
                </svg>
                Sign in with Microsoft
              </a>
            </div>

            <!-- Divider -->
            <div class="position-relative my-4">
              <hr class="text-muted" />
              <span class="position-absolute top-50 start-50 translate-middle bg-white px-3 text-muted"
                    style="font-size: 0.80rem; padding: 0 0.5rem;">
                Or sign in with username
              </span>
            </div>

            <!-- Local Login Form -->
            <form method="POST" id="loginForm">
              
              <!-- Username Field -->
              <div class="mb-3">
                <label for="username" class="form-label">
                  <i class="bi bi-person me-2"></i>Username
                </label>
                <input type="text" 
                       class="form-control" 
                       id="username" 
                       name="username" 
                       required 
                       placeholder="Enter your username" />
              </div>

              <!-- Password Field -->
              <div class="mb-3">
                <label for="password" class="form-label">
                  <i class="bi bi-lock me-2"></i>Password
                </label>
                <div class="input-group">
                  <input type="password" 
                         class="form-control" 
                         id="password" 
                         name="password" 
                         required 
                         placeholder="Enter your password" />
                  <button class="btn btn-outline-secondary" 
                          type="button" 
                          id="togglePassword">
                    <i class="bi bi-eye" id="toggleIcon"></i>
                  </button>
                </div>
              </div>

              <!-- Remember Me -->
              <div class="mb-3 form-check">
                <input type="checkbox" 
                       class="form-check-input" 
                       id="remember" 
                       name="remember" />
                <label class="form-check-label" for="remember">
                  Remember me
                </label>
              </div>

              <!-- Submit Button -->
              <div class="d-grid">
                <button type="submit" 
                        class="btn btn-gradient-primary btn-lg" 
                        id="loginBtn">
                  <i class="bi bi-box-arrow-in-right me-2"></i>Sign In
                </button>
              </div>
            </form>

            <!-- Register Link -->
            <div class="text-center mt-4">
              <p class="text-muted mb-2">Don't have an account?</p>
              <a href="{{ url_for('auth.register') }}" 
                 class="btn btn-outline-secondary">
                <i class="bi bi-person-plus me-2"></i>Create Account
              </a>
            </div>
            
          </div>
        </div>
        
      </div>
    </div>
  </div>
  
</div>

{% endblock %}

{% block extra_js %}
<script>
  document.addEventListener("DOMContentLoaded", function () {
    const loginForm = document.getElementById("loginForm");
    const loginBtn = document.getElementById("loginBtn");
    const togglePassword = document.getElementById("togglePassword");
    const passwordField = document.getElementById("password");
    const toggleIcon = document.getElementById("toggleIcon");

    // Toggle password visibility
    togglePassword.addEventListener("click", function () {
      const type = passwordField.getAttribute("type") === "password" ? "text" : "password";
      passwordField.setAttribute("type", type);

      // Toggle Bootstrap Icons
      toggleIcon.classList.toggle("bi-eye");
      toggleIcon.classList.toggle("bi-eye-slash");
    });

    // Handle form submission
    loginForm.addEventListener("submit", function (e) {
      e.preventDefault();

      const formData = new FormData(loginForm);
      const data = Object.fromEntries(formData);

      // Show loading state
      const originalText = loginBtn.innerHTML;
      loginBtn.innerHTML = '<i class="bi bi-arrow-repeat spinner-border spinner-border-sm me-2"></i>Signing In...';
      loginBtn.disabled = true;

      fetch('{{ url_for("auth.login") }}', {
        method: "POST",
        headers: {
          "Content-Type": "application/json",
        },
        body: JSON.stringify(data),
      })
        .then((response) => response.json())
        .then((data) => {
          if (data.success) {
            // Show success message briefly before redirect
            loginBtn.innerHTML = '<i class="bi bi-check-circle me-2"></i>Success!';
            loginBtn.style.backgroundColor = '#198754'; // Bootstrap success green
            loginBtn.style.borderColor = '#198754';

            setTimeout(() => {
              window.location.href = data.redirect;
            }, 1000);
          } else {
            // Show error
            const alertDiv = document.createElement("div");
            alertDiv.className = "alert alert-danger alert-dismissible fade show mt-3";
            alertDiv.innerHTML = `
              <i class="bi bi-exclamation-circle me-2"></i>${data.error}
              <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
            `;
            loginForm.insertBefore(alertDiv, loginForm.firstChild);

            // Reset button
            loginBtn.innerHTML = originalText;
            loginBtn.disabled = false;
          }
        })
        .catch((error) => {
          console.error("Error:", error);
          // Fallback to regular form submission
          loginForm.removeEventListener("submit", arguments.callee);
          loginForm.submit();
        });
    });

    // Add enter key support
    loginForm.addEventListener("keypress", function (e) {
      if (e.key === "Enter") {
        e.preventDefault();
        loginForm.dispatchEvent(new Event("submit"));
      }
    });
  });
</script>
{% endblock %}